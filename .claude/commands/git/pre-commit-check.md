stagedファイルの包括的なチェック

---

allowed-tools: ["Bash", "Read", "Edit", "MultiEdit", "Grep", "Glob", "TodoWrite", "TodoRead", "mcp__brave-search__brave_web_search", "mcp__context7__resolve-library-id", "mcp__context7__get-library-docs"]
description: "lefthookチェック実行、エラー修正、セキュリティ・品質分析を統合的に実施"

---

# pre-commit-check

ステージングされたファイルに対して、以下を統合的に実行します：

1. Lefthook pre-commitチェックの実行とエラー修正
2. セキュリティ・インシデントリスクの検出
3. コード品質とパフォーマンスの分析
4. 10の視点からの深層分析（オプション）

## Instructions

### 1. 初期状態の確認とタスク管理

TodoWriteツールで以下のタスクリストを作成：

- Lefthook pre-commitチェックの実行
- エラーがあれば修正
- セキュリティリスクの自動検出
- コード品質・パフォーマンスの分析
- 総合レポートの作成

### 2. Lefthook Pre-commitチェックの実行

#### 2.1 チェック項目の確認

```bash
cat lefthook.yml | grep -A 20 "pre-commit:"
```

#### 2.2 全チェックの実行

lefthook.ymlに定義されている全てのpre-commitコマンドを実行：

- biome（リンター/フォーマッター）
- typecheck（TypeScript型チェック）
- test-unit（ユニットテスト）
- test-integration（統合テスト）
- その他プロジェクト固有のチェック

#### 2.3 エラー修正の原則

**エラーが発生した場合は即座に最新情報を収集**

以下のコマンドで情報収集：

```
@.claude/commands/dev/arg-research.md
引数: [具体的なエラーメッセージ]
```

**TypeScript修正時の絶対禁止事項**：

- `any` 型の使用
- `as` によるタイプアサーション
- 解決できない場合はユーザーに承認を求める

### 3. ステージングファイルの取得と分析準備

```bash
# ステージングされたファイルを取得
git diff --cached --name-only --diff-filter=ACMR

# ファイルタイプと変更内容を確認
git diff --cached --name-status
```

ファイルが存在しない場合は、Lefthookチェックの結果のみを報告して終了。

### 4. セキュリティ・インシデントリスクの検出

以下のリスクを体系的にチェック：

#### 🔒 セキュリティチェック

- 機密情報の漏洩（APIキー、パスワード、トークン）
- 環境変数や設定ファイルの誤り
- SQLインジェクション等の脆弱性
- 認証・認可に関する問題
- ハードコーディングされた値

#### 🔍 コード品質チェック

- デバッグコードの残存（console.log、debugger等）
- 一時的な修正やTODOコメント
- 型安全性の問題（any型、@ts-ignore等）
- テストのスキップや無効化
- エラーハンドリングの不備

### 5. パフォーマンス・品質分析

#### ⚡ パフォーマンス観点

- 不要な再レンダリング（React/Next.js）
- N+1問題（ループ内でのAPI呼び出し）
- 重い計算処理の最適化機会
- バンドルサイズへの影響
- メモリリークの可能性

#### 🏗️ アーキテクチャ・保守性

- 命名規則とコーディング規約
- 適切な抽象化レベル
- 重複コードの検出
- テスタビリティ
- 変更の影響範囲

### 6. 必要に応じた最新情報の調査

以下の場合は最新技術情報を調査：

- 新しい依存関係やライブラリの追加
- セキュリティに関わる設定変更
- パフォーマンスクリティカルなコードの変更

調査内容：

- 使用技術の最新セキュリティ情報
- ベストプラクティスの更新
- 非推奨APIの確認

### 7. 統合レポートの作成

```
📋 Pre-commit統合チェックレポート
=====================================

✅ Lefthookチェック結果
------------------------
[各チェック項目の成功/失敗状態]

🔒 セキュリティ・リスク分析
---------------------------
Critical: [件数]
Warning: [件数]
Info: [件数]

[具体的な問題と修正提案]

📊 コード品質スコア（10点満点）
-------------------------------
- パフォーマンス: [スコア]/10
- 可読性: [スコア]/10
- 保守性: [スコア]/10
- セキュリティ: [スコア]/10

🎯 優先対応事項
---------------
1. [最も重要な対応事項]
2. [次に重要な対応事項]

💡 改善提案
-----------
[具体的な改善案と期待効果]

📝 コミット判定
---------------
□ 安全にコミット可能
□ 修正後にコミット推奨
□ レビュー後に判断
```

### 8. 深層分析オプション（--deep フラグ）

より詳細な分析が必要な場合は、10の視点から深層分析を実施：

1. エラーハンドリングの視点
2. パフォーマンスの視点
3. セキュリティの視点
4. 認証・認可の視点
5. 信頼性の視点
6. 保守性の視点
7. テスタビリティの視点
8. スケーラビリティの視点
9. 可観測性の視点
10. チーム開発の視点

各視点で「なぜ問題か」「いつ顕在化するか」を具体的に説明。

## 使用方法

### 基本的な使用

```
/git:pre-commit-check
```

### 深層分析を含む

```
/git:pre-commit-check --deep
```

### セキュリティ調査を積極的に実施

```
/git:pre-commit-check --with-security-research
```

## 成功基準

1. **Lefthookチェック**: 全項目が ✔️ で成功
2. **セキュリティ**: Criticalな問題が0件
3. **品質スコア**: 各項目7点以上が目安
4. **総合判定**: 「安全にコミット可能」

## 重要な原則

1. **実用性重視**: 過度に厳格にならず、現実的な提案を行う
2. **自動修正優先**: 可能な限り自動で問題を解決
3. **段階的改善**: 全てを一度に解決しようとしない
4. **人間の判断尊重**: 最終判断は開発者に委ねる
5. **継続的改善**: フィードバックを基に精度向上

## 注意事項

- エラー修正時は必ず最新情報を調査してから対応
- TypeScriptの`any`型と`as`は絶対に使用しない
- 誤検知の可能性を考慮し、コンテキストを重視した分析を行う
- プロジェクト固有の慣習やルールを考慮した分析
