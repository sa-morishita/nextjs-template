ステージング済みファイルのインシデント防止チェック

---

allowed-tools: ["Bash", "Read", "Grep", "TodoWrite", "mcp__brave-search__brave_web_search", "mcp__context7__resolve-library-id", "mcp__context7__get-library-docs"]
description: "stagedファイルを分析し、インシデントリスクを自律的に検出してレポート"

---

# pre-commit-safety-check

ステージングされているファイルを分析し、潜在的なインシデントリスクを検出してレポートします。

## 概要

このコマンドは、stagedファイルの内容を確認し、AIが自律的に以下のようなリスクを検出します：
- セキュリティリスク
- コード品質の問題
- 設定ミス
- その他プロジェクト固有のリスク

最終的に人間が判断できるレポートを出力します。

## Instructions

### 1. ステージングされているファイルの確認

!git status --porcelain | grep '^[AM]' | cut -c4-

ステージングされているファイルのリストを取得します。

### 2. ファイルタイプと変更内容の分析

!git diff --cached --name-status

各ファイルの変更タイプ（新規追加/修正）を確認し、以下の情報を収集：
- ファイルの拡張子と種類
- 変更の規模
- プロジェクトにおける重要度

### 3. 最新セキュリティ情報の事前調査

チェックポイントを決定する前に、必要に応じて最新のセキュリティ情報を取得：

#### 調査実施の判断基準
- 新しい依存関係やライブラリの追加がある場合
- セキュリティに関わる設定ファイルの変更
- 認証・認可に関するコードの変更
- 外部サービスとの連携コードの追加
- 前回の調査から一定期間が経過している場合

#### 調査内容

1. **プロジェクトで使用している技術の最新セキュリティ情報**：
   !date '+%Y年%m月'
   
   - 使用フレームワークの既知の脆弱性
   - 依存ライブラリのセキュリティアップデート
   - 新しく発見された攻撃手法

2. **ベストプラクティスの更新確認**：
   - MCP Context7で関連技術のセキュリティドキュメントを確認
   - OWASP Top 10などの標準的なセキュリティガイドラインの最新版

3. **類似プロジェクトでのインシデント事例**：
   - 同じ技術スタックでの最近のセキュリティインシデント
   - コミュニティで報告されている問題

### 4. チェックポイントの決定

ステージングされているファイルの内容と最新のセキュリティ情報に基づいて、以下のチェックポイントから必要なものを選択して実行：

#### 🔒 セキュリティチェックポイント
- [ ] 機密情報の漏洩（APIキー、パスワード、トークン）
- [ ] 環境変数や設定ファイルの誤り
- [ ] SQLインジェクションなどの脆弱性
- [ ] 認証・認可に関する問題
- [ ] ハードコーディングされた値

#### 🔍 コード品質チェックポイント
- [ ] デバッグコードの残存（console.log、debugger等）
- [ ] 一時的な修正やTODOコメント
- [ ] 型安全性の問題（any型、@ts-ignore等）
- [ ] テストのスキップや無効化
- [ ] エラーハンドリングの不備

#### ⚙️ 設定・依存関係チェックポイント
- [ ] package.jsonとlockファイルの整合性
- [ ] 設定ファイルの妥当性
- [ ] 環境依存の設定
- [ ] 不要または危険な依存関係

#### 📊 パフォーマンス・リソースチェックポイント
- [ ] 大きなファイルやバイナリファイル
- [ ] 最適化されていない画像
- [ ] 非効率なコードパターン
- [ ] メモリリークの可能性

#### 🏗️ アーキテクチャチェックポイント
- [ ] 命名規則やコーディング規約
- [ ] ディレクトリ構造の適切性
- [ ] 重複コードや不適切な抽象化
- [ ] 循環依存

### 5. 自律的なチェックの実行

上記のチェックポイントから、ファイルの内容に応じて必要なチェックを選択し、以下の手順で実行：

1. **優先度の決定**：ファイルの重要度とリスクレベルに基づいて、チェックの優先順位を決定

2. **適切なツールの選択**：
   - Grepツール: パターンマッチング検索
   - Readツール: ファイル内容の詳細確認
   - Bashツール: 追加の検証コマンド実行

3. **コンテキストを考慮した分析**：
   - プロジェクトの種類（Webアプリ、API、ライブラリ等）
   - 使用技術スタック
   - 過去のインシデント傾向
   - 事前調査で得た最新のセキュリティ情報

### 6. チェック結果の収集と分析

各チェックポイントの結果を収集し、以下の観点で分析：
- 誤検知の可能性
- 問題の深刻度
- 修正の緊急度
- 影響範囲
- 最新のセキュリティ基準との適合性

### 7. 最終レポートの作成

以下の形式で人間が判断しやすいレポートを作成：

```
📋 コミット前セーフティチェックレポート
========================================

📁 チェック対象ファイル: [ファイル数]件
[ファイルリスト]

🔍 実施したチェック:
[選択されたチェックポイントとその理由]

📊 チェック結果サマリー:

🚨 Critical（即座に対応が必要）: [件数]
[具体的な問題と該当箇所]

⚠️  Warning（修正を推奨）: [件数]
[具体的な問題と該当箇所]

ℹ️  Info（確認を推奨）: [件数]
[具体的な問題と該当箇所]

💡 推奨アクション:
1. [最も重要な対応事項]
2. [次に重要な対応事項]
...

📚 参考情報:
[調査した最新セキュリティ情報がある場合]

✅ 判断のポイント:
- [このままコミットした場合のリスク]
- [修正にかかる想定時間]
- [代替案や回避策]

🤔 最終判断: 
□ 安全にコミット可能
□ 修正後にコミット推奨
□ レビュー後に判断
```

### 7. インタラクティブな確認

レポート提示後、以下のオプションを提供：
- 特定の問題について詳細を確認
- 修正方法の提案を受ける
- 誤検知の報告とチェックルールの改善

## 使用例

```
/git:pre-commit-safety-check
```

## 調査オプション

最新セキュリティ情報の調査を積極的に行いたい場合：
```
/git:pre-commit-safety-check --with-security-research
```

## 重要な原則

1. **自律的判断**: ファイルの内容に応じて、AIが必要なチェックを自動選択
2. **コンテキスト重視**: プロジェクトの特性を考慮した分析
3. **人間の判断を尊重**: 最終的な判断は人間に委ね、AIは情報提供に徹する
4. **継続的改善**: フィードバックを基にチェック精度を向上

## 注意事項

- AIによる分析のため、完全性は保証されません
- プロジェクト固有のルールや慣習を学習しながら精度を向上させます
- 誤検知や見逃しの可能性があるため、最終的には人間の判断が必要です