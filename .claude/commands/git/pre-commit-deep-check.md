ステージング済みファイルを10の観点からAI分析

---

allowed-tools: ["Read", "Bash", "Glob", "Task", "TodoWrite", "TodoRead"]
description: "コードの深層分析とプロダクション品質チェック - 記事「同じコードでも見える世界が違う」のエッセンスを活用"

---

# pre-commit-deep-check

stagedファイルを10の重要な視点から徹底的に分析し、プロダクション品質のコードへと導きます。

## Instructions

### 1. Staged ファイルの取得と初期チェック

```bash
git diff --cached --name-only --diff-filter=ACMR | grep -E '\.(ts|tsx|js|jsx)$'
```

Stagedファイルが存在しない場合は、その旨を伝えて終了する。

### 2. TodoWrite で分析タスクを管理

以下のタスクリストを作成：

- Stagedファイルの一覧を取得
- 各ファイルについて10の観点から分析
- 重要度別に問題点を整理
- 具体的な改善提案を提示
- 次のステップを明確化

### 3. 各ファイルの深層分析

Stagedされた各ファイルに対して、以下の10の視点から徹底的に分析を行う。
単に問題を指摘するだけでなく、**なぜそれが問題なのか**、**どんな状況で問題が顕在化するか**を具体的に説明する。

#### 3.1 エラーハンドリングの視点 🛡️

```typescript
// 分析ポイント
- try-catchブロックの有無と適切性
- fetchやAPIコールでのHTTPステータスコードのチェック
- エラーオブジェクトの型安全性
- ユーザーへの適切なエラーメッセージ
- エラーの伝播と境界の明確化
```

**チェック例：**

- `fetch`が5xxエラーでも例外を投げない問題
- エラーレスポンスのJSONに偶然同じプロパティが含まれる可能性
- Result型やEither型の活用提案
- エラーバウンダリーの設置

#### 3.2 パフォーマンスの視点 ⚡

```typescript
// 分析ポイント
- N+1問題（ループ内でのAPI呼び出しやDB問い合わせ）
- オーバーフェッチ（必要以上のデータ取得）
- 不要な再レンダリング
- 重い計算処理のメモ化不足
- バンドルサイズへの影響
```

**チェック例：**

- 配列の各要素に対してAPIを個別に呼び出していないか
- `useMemo`、`useCallback`の適切な使用
- 動的インポートによるコード分割の可能性
- 画像やリソースの遅延読み込み

#### 3.3 セキュリティの視点 🔒

```typescript
// 分析ポイント
-入力値の検証とサニタイゼーション -
  SQLインジェクション対策 -
  XSS対策 -
  機密情報のハードコーディング -
  HTTPS通信の確認;
```

**チェック例：**

- ユーザー入力をそのままURLやクエリに埋め込んでいないか
- `dangerouslySetInnerHTML`の使用
- 環境変数の適切な管理
- CSRFトークンの実装

#### 3.4 認証・認可の視点 🔑

```typescript
// 分析ポイント
-認証トークンの適切な管理 -
  アクセス権限のチェック -
  セッション管理 -
  認証状態の一貫性;
```

**チェック例：**

- APIコールにおける認証ヘッダーの付与
- ロールベースアクセス制御（RBAC）
- JWT の検証とリフレッシュ
- 機密リソースへの不正アクセス防止

#### 3.5 信頼性の視点 🏗️

```typescript
// 分析ポイント
-タイムアウト設定 -
  リトライロジック -
  サーキットブレーカーパターン -
  フォールバック処理 -
  楽観的更新の実装;
```

**チェック例：**

- ネットワークリクエストの無限待機リスク
- 一時的な障害への対処
- 指数バックオフの実装
- デグレード時の代替処理

#### 3.6 保守性の視点 🔧

```typescript
// 分析ポイント
- 型安全性（any型の使用）
- マジックナンバー/文字列
- 設定の外部化
- コードの重複
- 命名の一貫性と明確性
```

**チェック例：**

- ハードコードされたURL、定数
- 複雑な条件分岐の簡略化
- 共通ロジックの抽出
- インターフェースの明確化

#### 3.7 テスタビリティの視点 🧪

```typescript
// 分析ポイント
-依存性注入の可能性 -
  モック可能な設計 -
  純粋関数への分離 -
  テストしやすい粒度 -
  副作用の分離;
```

**チェック例：**

- グローバル変数への依存
- 外部システムとの密結合
- ビジネスロジックとUIロジックの分離
- テスト用のフックポイント

#### 3.8 スケーラビリティの視点 📈

```typescript
// 分析ポイント
-バッチ処理の可能性 -
  ページネーション実装 -
  レート制限への対応 -
  キューイングの必要性 -
  キャッシング戦略;
```

**チェック例：**

- 大量データ処理時のメモリ使用
- 同時実行数の制限
- バックプレッシャーの実装
- 水平スケーリングへの対応

#### 3.9 可観測性の視点 📊

```typescript
// 分析ポイント
-適切なログ出力 -
  エラートラッキング -
  パフォーマンスメトリクス -
  トレーシング情報 -
  デバッグ情報の充実;
```

**チェック例：**

- 構造化ログの実装
- 重要なイベントの記録
- コンテキスト情報の付与
- メトリクスの収集ポイント

#### 3.10 チーム開発・Vibe Codingの視点 👥

```typescript
// 分析ポイント
-コードの可読性 -
  意図の明確性 -
  ドキュメントの必要性 -
  AIへの指示の明確性 -
  将来の拡張性;
```

**チェック例：**

- 複雑なロジックへのコメント
- 型定義の充実
- エッジケースの明示
- AIが理解しやすい構造

### 4. 分析結果の出力形式

#### 4.1 サマリーセクション

```markdown
## 📋 分析サマリー

### ファイル数

- 分析対象: X ファイル
- 問題検出: Y ファイル

### 重要度別の問題

- 🔴 **クリティカル** (即座に修正すべき): N件
- 🟡 **重要** (リリース前に修正推奨): N件
- 🔵 **改善提案** (将来的な品質向上): N件
```

#### 4.2 ファイル別詳細分析

各ファイルについて：

````markdown
## 📄 `path/to/file.ts`

### 🔴 クリティカルな問題

#### 1. エラーハンドリングの欠如

**問題のコード：**

```typescript
const response = await fetch(url);
const data = await response.json();
```
````

**なぜ問題か：**

- 500エラー時にもresponse.json()が実行され、パースエラーで予期しない挙動
- ネットワークエラー時にユーザーに何も表示されない

**いつ顕在化するか：**

- APIサーバーがダウンした時
- レート制限に達した時
- ネットワーク接続が不安定な時

**改善案：**

```typescript
try {
  const response = await fetch(url);
  if (!response.ok) {
    throw new Error(`HTTP error! status: ${response.status}`);
  }
  const data = await response.json();
  return { ok: true, data };
} catch (error) {
  console.error("API call failed:", error);
  return { ok: false, error: error.message };
}
```

````

### 5. 総合評価と次のステップ

```markdown
## 🎯 総合評価

このコードベースは [初級/中級/上級] レベルの品質です。

### 強み
- [良い点をリストアップ]

### 成長の機会
- [改善できる領域]

### 推奨される学習パス
1. **即座に学ぶべき**: [最も重要なトピック]
2. **次に学ぶべき**: [次に重要なトピック]
3. **将来的に学ぶべき**: [長期的な成長のためのトピック]

### 具体的なアクションアイテム
- [ ] クリティカルな問題の修正
- [ ] エラーハンドリングパターンの統一
- [ ] パフォーマンス測定の実施
- [ ] セキュリティ監査の計画
````

### 6. 特別な配慮事項

- **建設的なフィードバック**: 問題を指摘するだけでなく、なぜそれが重要で、どう改善できるかを示す
- **段階的な成長**: エンジニアのレベルに応じて、理解しやすい説明と実践的な改善案を提供
- **コンテキストの重要性**: プロトタイプなのか本番コードなのか、スタートアップなのか大企業なのかで、優先度は変わることを認識
- **トレードオフの明示**: すべてを完璧にはできないことを理解し、何を優先すべきかを示す

### 7. コマンドの哲学

このコマンドは、単なるリンターではありません。
同じコードでも、経験と知識によって「見える世界が違う」という哲学に基づいています。

初心者には：

- なぜその実装が問題になるのかを具体的に説明
- どんな状況で問題が顕在化するかを示す
- 段階的に改善できる道筋を提示

経験者には：

- より深い洞察と最新のベストプラクティス
- トレードオフを意識した現実的な提案
- チーム全体の成長につながる知見

最終的に、このコマンドを通じて：

- **コードの向こう側にある世界が見えるようになる**
- **なぜを理解し、より良い選択ができるようになる**
- **チーム全体のコード品質が向上する**

これが、このコマンドの目指す世界です。
